# Отчет по лабораторной работе №1
# Архитектура СУБД и конфигурация

## Сведения о студенте
**Дата:** [2004-10-28]
**Семестр:** 7
**Группа:** ПИЖ-б-о-22-1
**Дисциплина:** Администрирование баз данных
**Студент:** Горчаков Роман Владимирович

## Цель работы
Изучить базовые компоненты архитектуры PostgreSQL (процессы, память) и получить практические навыки управления конфигурационными параметрами сервера на разных уровнях (экземпляр, сеанс).
Освоить работу с основными и дополнительными файлами конфигурации, а также с представлениями pg_settings и pg_file_settings.

## Теоретическая часть
### Изученные концепции
- Контексты параметров: значения, которые определяют, когда и как можно изменять значение параметра.

### Ключевые термины
- **Общая память:** разделяемый буферный кеш
- **Локальная память:** область памяти, выделяемая в начале выполнения некоторого фрагмента результирующей программы
- **Параметры конфигурации:** настройки, определяющие поведение сервера

## Практическая часть

### Модуль 1: Исследование параметров и файлов конфигурации

#### Задача 1: Текущая конфигурация
**Цель:** Подключиться к серверу и определить расположение основного файла конфигурации

**Выполненные действия:**
SHOW config_file;

**Результаты:**
               config_file               
-----------------------------------------
 /etc/postgresql/16/main/postgresql.conf
(1 row)

#### Задача 2: Анализ параметров
**Цель:** Изучить представление pg_settings, найти параметры, для изменения которых требуется перезагрузка сервера (context = 'postmaster'), а также 2-3 параметра с контекстом sighup и user.

**Выполненные действия:**
1. SELECT name, setting, unit FROM pg_settings WHERE context = 'postmaster';
2. SELECT name, setting, unit FROM pg_settings WHERE context = 'sighup';
3. SELECT name, setting, unit FROM pg_settings WHERE context = 'user';

**Результаты:**
1.
                name                 |                 setting                 | unit 
-------------------------------------+-----------------------------------------+------
 archive_mode                        | off                                     | 
 autovacuum_freeze_max_age           | 200000000                               | 
 autovacuum_max_workers              | 3                                       | 
 autovacuum_multixact_freeze_max_age | 400000000                               | 
 bonjour                             | off                                     | 
 bonjour_name                        |                                         | 
 cluster_name                        | 16/main                                 | 
 config_file                         | /etc/postgresql/16/main/postgresql.conf | 
 data_directory                      | /var/lib/postgresql/16/main             | 
 data_sync_retry                     | off                                     | 
 debug_io_direct                     |                                         | 
 dynamic_shared_memory_type          | posix                                   | 
 event_source                        | PostgreSQL                              | 
 external_pid_file                   | /var/run/postgresql/16-main.pid         | 
 hba_file                            | /etc/postgresql/16/main/pg_hba.conf     | 
 hot_standby                         | on                                      | 
 huge_page_size                      | 0                                       | kB
 huge_pages                          | try                                     | 
 ident_file                          | /etc/postgresql/16/main/pg_ident.conf   | 
 ignore_invalid_pages                | off                                     | 
 jit_provider                        | llvmjit                                 | 
 listen_addresses                    | localhost                               | 
 logging_collector                   | off                                     | 
 max_connections                     | 100                                     | 
 max_files_per_process               | 1000                                    | 
 max_locks_per_transaction           | 64                                      | 
 max_logical_replication_workers     | 4                                       | 
 max_pred_locks_per_transaction      | 64                                      | 
 max_prepared_transactions           | 0                                       | 
 max_replication_slots               | 10                                      | 
 max_wal_senders                     | 10                                      | 
 max_worker_processes                | 8                                       | 
 min_dynamic_shared_memory           | 0                                       | MB
 old_snapshot_threshold              | -1                                      | min
 port                                | 5432                                    | 
 recovery_target                     |                                         | 
 recovery_target_action              | pause                                   | 
 recovery_target_inclusive           | on                                      | 
 recovery_target_lsn                 |                                         | 
 recovery_target_name                |                                         | 
 recovery_target_time                |                                         | 
 recovery_target_timeline            | latest                                  | 
 recovery_target_xid                 |                                         | 
 reserved_connections                | 0                                       | 
 shared_buffers                      | 16384                                   | 8kB
 shared_memory_type                  | mmap                                    | 
 shared_preload_libraries            |                                         | 
 superuser_reserved_connections      | 3                                       | 
 track_activity_query_size           | 1024                                    | B
 track_commit_timestamp              | off                                     | 
 unix_socket_directories             | /var/run/postgresql                     | 
 unix_socket_group                   |                                         | 
 unix_socket_permissions             | 0777                                    | 
 wal_buffers                         | 512                                     | 8kB
 wal_decode_buffer_size              | 524288                                  | B
 wal_level                           | replica                                 | 
 wal_log_hints                       | off                                     | 
(57 rows)

2.
(END)

                    name                     |                 setting                 | unit 
---------------------------------------------+-----------------------------------------+------
 archive_cleanup_command                     |                                         | 
 archive_command                             | (disabled)                              | 
 archive_library                             |                                         | 
(3 rows)

(END)

3.
                name                 |      setting       | unit 
-------------------------------------+--------------------+------
 application_name                    | psql               | 
 array_nulls                         | on                 | 
 backend_flush_after                 | 0                  | 8kB
(3 rows)

(END)

#### Задача 3: Анализ файлов
**Цель:** Изучить представление pg_file_settings и определить, из каких файлов и с какими значениями были считаны текущие настройки параметров shared_buffers и work_mem.

**Выполненные действия:**
1. SELECT * FROM pg_settings s WHERE name = 'shared_buffers';
2. SELECT * FROM pg_settings s WHERE name = 'work_mem';

**Результаты:**
1.
      name      | setting | unit |        category         |                          short_desc                          | extra_desc |  context   | vartype |       source       | min_val |  max_val   | enumvals | boot_val | reset_val |               sourcefile                | sourceline | pending_restart 
----------------+---------+------+-------------------------+--------------------------------------------------------------+------------+------------+---------+--------------------+---------+------------+----------+----------+-----------+-----------------------------------------+------------+-----------------
 shared_buffers | 16384   | 8kB  | Resource Usage / Memory | Sets the number of shared memory buffers used by the server. |            | postmaster | integer | configuration file | 16      | 1073741823 |          | 16384    | 16384     | /etc/postgresql/16/main/postgresql.conf |        130 | f
(1 row)

(END)

2.
   name   | setting | unit |        category         |                        short_desc                        |                                                      extra_desc                                                       | context | vartype | source  | min_val |  max_val   | enumvals | boot_val | reset_val | sourcefile | sourceline | pending_restart 
----------+---------+------+-------------------------+----------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+---------+---------+---------+---------+------------+----------+----------+-----------+------------+------------+-----------------
 work_mem | 4096    | kB   | Resource Usage / Memory | Sets the maximum memory to be used for query workspaces. | This much memory can be used by each internal sort operation and hash table before switching to temporary disk files. | user    | integer | default | 64      | 2147483647 |          | 4096     | 4096      |            |            | f
(1 row)

(END)

### Модуль 2: Управление параметрами на уровне экземпляра

#### Задача 1: Изменение через ALTER SYSTEM
**Цель:** Используя команду ALTER SYSTEM, установить для параметра work_mem новое значение, убедиться, что изменение записалось в файл postgresql.auto.conf, применить изменение, перечитав конфигурацию, и проверить новое значение параметра и его источник в pg_settings.

**Выполненные действия:**
1. ALTER SYSTEM SET work_mem TO 2025;
2. SELECT pg_read_file('postgresql.auto.conf');
3. SELECT pg_reload_conf();

**Результаты:**
1. 
ALTER SYSTEM

2.
                     pg_read_file                      
-------------------------------------------------------
 # Do not edit this file manually!                    +
 # It will be overwritten by the ALTER SYSTEM command.+
 work_mem = '2025'                                    +
 
(1 row)

3. 
 pg_reload_conf 
----------------
 t
(1 row)

                    name                     |                 setting                 |                    sourcefile                    | sourceline 
---------------------------------------------+-----------------------------------------+--------------------------------------------------+------------
 allow_in_place_tablespaces                  | off                                     |                                                  |           
 allow_system_table_mods                     | off                                     |                                                  |           
 application_name                            | psql                                    |                                                  |           
 archive_cleanup_command                     |                                         |                                                  |           
 archive_command                             | (disabled)                              |                                                  |           
 archive_library                             |                                         |                                                  |           
 archive_mode                                | off                                     |                                                  |           
 archive_timeout                             | 0                                       |                                                  |           
 array_nulls                                 | on                                      |                                                  |           
 authentication_timeout                      | 60                                      |                                                  |           
 autovacuum                                  | on                                      |                                                  |           
 autovacuum_analyze_scale_factor             | 0.1                                     |                                                  |           
 autovacuum_analyze_threshold                | 50                                      |                                                  |           
 autovacuum_freeze_max_age                   | 200000000                               |                                                  |           
 autovacuum_max_workers                      | 3                                       |                                                  |           
 autovacuum_multixact_freeze_max_age         | 400000000                               |                                                  |           
 autovacuum_naptime                          | 60                                      |                                                  |           
 autovacuum_vacuum_cost_delay                | 2                                       |                                                  |           
 autovacuum_vacuum_cost_limit                | -1                                      |                                                  |           
 autovacuum_vacuum_insert_scale_factor       | 0.2                                     |                                                  |           
 autovacuum_vacuum_insert_threshold          | 1000                                    |                                                  |           
 autovacuum_vacuum_scale_factor              | 0.2                                     |                                                  |           
 autovacuum_vacuum_threshold                 | 50                                      |                                                  |           
 autovacuum_work_mem                         | -1                                      |                                                  |           
 backend_flush_after                         | 0                                       |                                                  |           
 backslash_quote                             | safe_encoding                           |                                                  |           
 backtrace_functions                         |                                         |                                                  |           
 bgwriter_delay                              | 200                                     |                                                  |           
 bgwriter_flush_after                        | 64                                      |                                                  |           
 bgwriter_lru_maxpages                       | 100                                     |                                                  |           
 bgwriter_lru_multiplier                     | 2                                       |                                                  |           
 block_size                                  | 8192                                    |                                                  |           
 bonjour                                     | off                                     |                                                  |           
 bonjour_name                                |                                         |                                                  |           
 bytea_output                                | hex                                     |                                                  |           
 check_function_bodies                       | on                                      |                                                  |           
 checkpoint_completion_target                | 0.9                                     |                                                  |           
 checkpoint_flush_after                      | 32                                      |                                                  |           
 checkpoint_timeout                          | 300                                     |                                                  |           
 checkpoint_warning                          | 30                                      |                                                  |           
 client_connection_check_interval            | 0                                       |                                                  |           
 client_encoding                             | UTF8                                    |                                                  |           
 client_min_messages                         | notice                                  |                                                  |           
 cluster_name                                | 16/main                                 | /etc/postgresql/16/main/postgresql.conf          |        607
 commit_delay                                | 0                                       |                                                  |           
 commit_siblings                             | 5                                       |                                                  |           
 compute_query_id                            | auto                                    |                                                  |           
 config_file                                 | /etc/postgresql/16/main/postgresql.conf |                                                  |           
 constraint_exclusion                        | partition                               |                                                  |           
 cpu_index_tuple_cost                        | 0.005                                   |                                                  |           
 cpu_operator_cost                           | 0.0025                                  |                                                  |           
 cpu_tuple_cost                              | 0.01                                    |                                                  |           
 createrole_self_grant                       |                                         |                                                  |           
 cursor_tuple_fraction                       | 0.1                                     |                                                  |           
 data_checksums                              | off                                     |                                                  |           
 data_directory                              | /var/lib/postgresql/16/main             |                                                  |           
 data_directory_mode                         | 0700                                    |                                                  |           
 data_sync_retry                             | off                                     |                                                  |           
 DateStyle                                   | ISO, DMY                                | /etc/postgresql/16/main/postgresql.conf          |        715
 db_user_namespace                           | off                                     |                                                  |           
 deadlock_timeout                            | 1000                                    |                                                  |           
 debug_assertions                            | off                                     |                                                  |           
 debug_discard_caches                        | 0                                       |                                                  |           
 debug_io_direct                             |                                         |                                                  |           

## Результаты выполнения

### Сводная таблица результатов
| Модуль | Задача | Статус | Ключевые наблюдения |
|--------|--------|--------|---------------------|
| 1 | 1 | ✅ Выполнено | Команда SHOW определяет расположение postgresql.conf |
| 1 | 2 | ✅ Выполнено | pg_settings открывает доступ к параметрам времени выполнения сервера |
| 1 | 3 | ✅ Выполнено | pg_file_settings показывает содержимое файлов конфигурации сервера |
| 2 | 1 | ✅ Выполнено | ALTER SYSTEM позволяет изменять значения параметров файла |

## Анализ и выводы

### Основные наблюдения
1. pg_settings — системное представление в PostgreSQL, которое открывает доступ к параметрам времени выполнения сервера. Представление позволяет получить некоторые свойства каждого параметра, которые нельзя получить непосредственно из команды SHOW, например, минимальные и максимальные значения, а также поиск контекстов параметров.
2. pg_file_settings — это представление в PostgreSQL, которое показывает содержимое файлов конфигурации сервера. Оно добавляет информацию о текущем содержимом всех конфигурационных файлов, включая дублирующиеся элементы, и о том, можно ли применить значение.

### Сравнительный анализ
- Сравнение контекстов параметров postmaster, sighup и user.
При использовании postmaster параметр устанавливается при старте сервера, и любое изменение требует перезапуска сервера.
При использовании sighup внесённые в postgresql.conf изменения можно применить, не перезапуская сервер.
При использовании user параметры можно задать в postgresql.conf или в рамках сеанса командой SET, и в рамках сеанса изменять их разрешено всем пользователям.
- Сравнение применения изменений через ALTER SYSTEM и через SET/SET LOCAL.
Разница между применением изменений через ALTER SYSTEM и через SET/SETLOCAL заключается в контексте использования. ALTER SYSTEM — команда для изменения параметров конфигурации в базах данных. SET/SETLOCAL — команды в командной строке для изменения переменных.